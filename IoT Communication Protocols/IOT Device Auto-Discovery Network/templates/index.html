<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IoT DNS Device Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-3">IoT Device Auto-Discovery Network</h1>
  <p class="text-muted">Live devices registered by ESP32 clients</p>

  <div id="alert-area"></div>

  <div class="card">
    <div class="card-body">
      <table class="table table-hover" id="devices-table">
        <thead>
          <tr>
            <th>Device Name</th>
            <th>IP</th>
            <th>Status</th>
            <th>Last Seen (UTC)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="devices-body">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const apiBase = window.location.origin;

async function fetchDevices() {
  try {
    const res = await fetch(apiBase + '/devices');
    const data = await res.json();
    return data.devices || [];
  } catch(err) {
    showAlert('Could not reach server: ' + err.message, 'danger');
    return [];
  }
}

function showAlert(msg, type='info', timeout=5000) {
  const area = document.getElementById('alert-area');
  const el = document.createElement('div');
  el.className = `alert alert-${type} alert-dismissible`;
  el.innerHTML = `${msg} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  area.appendChild(el);
  if(timeout) setTimeout(()=> el.remove(), timeout);
}

async function ping(ip) {
  // naive attempt - try HTTP request to port 80 (may not always work),
  // mostly for demo. In production use ICMP (server-side).
  try {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), 2000);
    const resp = await fetch('http://' + ip + '/', {mode:'no-cors', signal: controller.signal});
    clearTimeout(id);
    return true;
  } catch(e) {
    return false;
  }
}

function renderDevices(devices) {
  const tbody = document.getElementById('devices-body');
  tbody.innerHTML = '';
  devices.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(d.device_name)}</td>
      <td>${escapeHtml(d.ip)}</td>
      <td>${escapeHtml(d.status)}</td>
      <td>${escapeHtml(d.last_seen || '')}</td>
      <td>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteDevice('${encodeURIComponent(d.device_name)}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function escapeHtml(s){
  if(!s) return '';
  return s.toString().replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

async function deleteDevice(nameEscaped) {
  const name = decodeURIComponent(nameEscaped);
  if(!confirm(`Delete device ${name}?`)) return;
  try {
    const res = await fetch(apiBase + '/delete/' + encodeURIComponent(name), {method:'DELETE'});
    if(res.ok) showAlert('Deleted ' + name, 'success');
  } catch(e) {
    showAlert('Delete failed: ' + e.message, 'danger');
  }
}

async function refreshLoop(){
  const devices = await fetchDevices();
  renderDevices(devices);
}

setInterval(refreshLoop, 4000);
refreshLoop();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
